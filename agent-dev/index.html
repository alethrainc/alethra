<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ALETHRA - ALETHA</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="/animation.css">    

<script>
tailwind.config = {
    theme: {
        extend: {
            colors: {
                'klyr-red': '#E72F3C',
                'klyr-dark': '#1F2937',
            },
            fontFamily: {
                sans: ['Inter', 'sans-serif'],
            }
        }
    }
}
</script>

<style>
@media (min-width: 768px) { .description-alignment-fix { min-height: 3.5rem; } }
.skiptranslate { display: none!important; }
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
body { font-family: 'Inter', sans-serif; background-color: white; top:0px !important; position:relative !important; }
.max-w-site { max-width: 1100px; }
.max-w-super-wide { max-width: 2000px; }
.crisis-card-style { background-color: #f9f9f9; box-shadow: 0 0px 0px rgba(0, 0, 0, 0.08); }
#content-box.content-box-border-style { border: 4px solid var(--klyr-red) !important; }
#google_translate_element, .goog-te-gadget, .goog-te-banner-frame { display: none !important; visibility: hidden !important; }
.nav-item:hover { color: #E72F3C; }
.mobile-dropdown-group { @apply border-b border-gray-100; }
.mobile-dropdown-group:not(:first-child) { margin-top: 18px; }
.mobile-nav-item-base { @apply w-full flex justify-between items-center text-left text-base font-medium text-klyr-dark hover:text-klyr-red py-3 pr-0 transition duration-150; }
.mobile-dropdown-content { max-height: 0; opacity: 0; padding-left: 32px; @apply overflow-hidden bg-gray-50 transition-all duration-300; }
.mobile-dropdown-content.open { opacity:1; pointer-events:auto; }
.mobile-sub-item { padding-top:16px; padding-bottom:16px; @apply block text-sm text-klyr-dark hover:text-klyr-red uppercase; }
.mobile-dropdown-content .mobile-sub-item:not(:first-child) { @apply border-t border-gray-300; }

/* Video fixes */
#avatar {
    background-color: black; /* fallback if no stream */
    min-height: 200px;
    display: block;
    width: 100%;
    object-fit: contain;
}
/* Debug overlay */
#debug-overlay {
    position: absolute;
    bottom: 8px;
    left: 8px;
    background: rgba(0,0,0,0.6);
    color: #fff;
    font-size: 0.8rem;
    padding: 4px 8px;
    border-radius: 4px;
    z-index: 10;
    pointer-events: none;
}
</style>
</head>
<body>

<div id="google_translate_element"></div>
<script type="text/javascript">
function googleTranslateElementInit() {
    new google.translate.TranslateElement({
        pageLanguage: 'en',
        autoDisplay: false,
        layout: google.translate.TranslateElement.InlineLayout.HORIZONTAL
    }, 'google_translate_element');
}
</script>
<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<div class="bg-white shadow-sm sticky top-0 z-50" id="nav-placeholder"></div>

<main class="py-10 flex justify-center">
    <div class="relative w-full max-w-md">
        <video id="avatar" autoplay playsinline muted class="rounded-xl shadow-lg w-full h-auto"></video>
        <div id="loading-overlay" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white text-lg font-semibold">
            Loading avatar...
        </div>
        <div id="debug-overlay">Debug: Waiting for stream...</div>
    </div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
    const video = document.getElementById("avatar");
    const overlay = document.getElementById("loading-overlay");
    const debug = document.getElementById("debug-overlay");

    function logDebug(msg) {
        console.log(msg);
        if (debug) debug.textContent = "Debug: " + msg;
    }

    try {
        const res = await fetch("/api/did/createStream");
        const data = await res.json();
        logDebug("Stream info received");

        // Ensure we have correct variables
        let { id: streamId, offer, ice_servers } = data;
        const iceServers = ice_servers && ice_servers.length > 0
            ? ice_servers
            : [{ urls: "stun:stun.l.google.com:19302" }];

        const pc = new RTCPeerConnection({ iceServers });

        // Track received handler
        pc.ontrack = (event) => {
            logDebug("Track received");
            video.srcObject = event.streams[0];
            if (overlay) overlay.style.display = "none";

            // Log video/audio tracks
            const vTracks = event.streams[0].getVideoTracks();
            const aTracks = event.streams[0].getAudioTracks();
            logDebug(`Video tracks: ${vTracks.length}, Audio tracks: ${aTracks.length}`);

            // Debug each track
            vTracks.forEach(t => console.log("Video track:", t));
            aTracks.forEach(t => console.log("Audio track:", t));
        };

        pc.onicecandidate = (event) => {
            if (event.candidate) logDebug(`ICE candidate: ${event.candidate.type}`);
        };

        await pc.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        await fetch("/api/did/sdp", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ streamId, sdp: pc.localDescription })
        });

        logDebug("✅ Agent stream started");

        // Ensure autoplay works
        video.onloadedmetadata = () => video.play().catch(err => logDebug("Video play failed: " + err));

        // Extra debug: update every second if video frames are coming
        setInterval(() => {
            if (video.readyState >= 2) {
                const frameCheck = video.videoWidth + "x" + video.videoHeight;
                logDebug(`Video playing, size: ${frameCheck}`);
            }
        }, 1000);

    } catch (err) {
        console.error("❌ Failed to start agent:", err);
        if (overlay) overlay.textContent = "Failed to load avatar";
        logDebug("Failed to start agent");
    }
});
</script>

</main>

<div id="country-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[100] hidden opacity-0 modal-transition">
    <div id="modal-content" class="bg-white rounded-2xl shadow-2xl w-11/12 max-w-4xl p-8 relative transform scale-95 modal-transition">
        <button id="close-modal-btn" class="absolute top-6 left-6 text-gray-500 hover:text-klyr-red transition duration-150">
            <i class="fas fa-times text-2xl"></i>
        </button>
        <div id="country-list-container" class="mt-12 grid grid-cols-2 md:grid-cols-3 gap-x-10 gap-y-4 max-h-[70vh] overflow-y-auto pt-4 pb-2"></div>
    </div>
</div>

<div id="footer-placeholder"></div>
<script src="/animation.js"></script>
<script src="/nav-logic.js"></script>
<script src="/inject.js"></script>
<script src="/symbol-formatter.js"></script>

</body>
</html>
